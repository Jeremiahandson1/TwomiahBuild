<%
  // Extract data from locals
  const project = locals.project || {};
  const relatedProjects = locals.relatedProjects || [];
  const images = project.images || [];
  const completedYear = project.completedAt ? new Date(project.completedAt).getFullYear() : null;
%>

<div class="project-detail">
  <!-- Hero Section - Full Width Image -->
  <section class="project-hero">
    <% if (images.length > 0) { %>
      <div class="project-hero-image" onclick="openLightbox(0)">
        <img src="<%= images[0].url %>" alt="<%= project.title %>">
        <div class="hero-zoom-hint">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            <line x1="11" y1="8" x2="11" y2="14"></line>
            <line x1="8" y1="11" x2="14" y2="11"></line>
          </svg>
          <span>Click to enlarge</span>
        </div>
      </div>
    <% } else { %>
      <div class="project-hero-placeholder">
        <span><%= project.category || 'Project' %></span>
      </div>
    <% } %>
  </section>

  <!-- Project Info Bar -->
  <section class="project-info-bar">
    <div class="container">
      <div class="project-info-content">
        <div class="project-info-main">
          <h1><%= project.title %></h1>
        </div>
        <div class="project-info-meta">
          <% if (project.category) { %>
            <div class="meta-item">
              <span class="meta-label">Category</span>
              <span class="meta-value"><%= project.category %></span>
            </div>
          <% } %>
          <% if (project.location) { %>
            <div class="meta-item">
              <span class="meta-label">Location</span>
              <span class="meta-value"><%= project.location %></span>
            </div>
          <% } %>
          <% if (completedYear) { %>
            <div class="meta-item">
              <span class="meta-label">Completed</span>
              <span class="meta-value"><%= completedYear %></span>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </section>

  <!-- Main Content -->
  <section class="project-content">
    <div class="container">
      <div class="project-layout">
        <!-- Left Column - Gallery & Description -->
        <div class="project-main">
          <!-- Thumbnail Gallery -->
          <% if (images.length > 1) { %>
            <div class="project-gallery-grid">
              <% 
                const thumbnails = images.slice(1, 7);
                const hasMore = images.length > 7;
              %>
              <% thumbnails.forEach((image, index) => { %>
                <div class="gallery-thumb" onclick="openLightbox(<%= index + 1 %>)">
                  <img 
                    src="<%= image.thumbnail || image.url %>"
                    alt="<%= image.caption || `Project image ${index + 2}` %>"
                  >
                  <div class="thumb-overlay">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="11" cy="11" r="8"></circle>
                      <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                  </div>
                </div>
              <% }); %>
              
              <% if (hasMore) { %>
                <div class="gallery-thumb more-photos" onclick="openLightbox(7)">
                  <img 
                    src="<%= images[7].thumbnail || images[7].url %>"
                    alt="More photos"
                  >
                  <div class="more-overlay">
                    <span>+<%= images.length - 7 %></span>
                    <span>more photos</span>
                  </div>
                </div>
              <% } %>
            </div>
          <% } %>

          <!-- Project Description -->
          <div class="project-description">
            <h2>About This Project</h2>
            <p><%= project.description || 'Professional workmanship and quality materials deliver lasting results for this project.' %></p>
          </div>
        </div>

        <!-- Right Column - CTA Sidebar -->
        <aside class="project-sidebar">
          <div class="cta-card">
            <h3>Want Similar Results?</h3>
            <p>Get a free, no-obligation estimate for your project.</p>
            <a href="/#contact" class="btn btn-primary btn-block">
              Get Free Estimate
            </a>
            <a href="tel:5551234567" class="btn btn-outline btn-block">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
              </svg>
              (555) 123-4567
            </a>
          </div>

          <div class="trust-indicators">
            <div class="trust-item">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                <polyline points="9 12 11 14 15 10"></polyline>
              </svg>
              <span>Licensed & Insured</span>
            </div>
            <div class="trust-item">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="8" r="7"></circle>
                <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline>
              </svg>
              <span>Quality Guaranteed</span>
            </div>
            <div class="trust-item">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
              <span>Free Estimates</span>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </section>

  <!-- Related Projects -->
  <% if (relatedProjects.length > 0) { %>
    <section class="related-projects">
      <div class="container">
        <div class="section-header">
          <h2>Similar Projects</h2>
          <a href="/gallery" class="view-all-link">View All Projects â†’</a>
        </div>
        <div class="related-grid">
          <% relatedProjects.forEach(rp => { %>
            <a href="/gallery/<%= rp.id %>" class="related-card">
              <div class="related-image">
                <% if (rp.images && rp.images[0]) { %>
                  <img 
                    src="<%= rp.images[0].thumbnail || rp.images[0].url %>"
                    alt="<%= rp.title %>"
                  >
                <% } else { %>
                  <div class="placeholder">
                    <span><%= rp.category || 'Project' %></span>
                  </div>
                <% } %>
                <div class="related-overlay">
                  <span>View Project</span>
                </div>
              </div>
              <div class="related-info">
                <span class="related-category"><%= rp.category %></span>
                <h3><%= rp.title %></h3>
                <% if (rp.location) { %>
                  <p><%= rp.location %></p>
                <% } %>
              </div>
            </a>
          <% }); %>
        </div>
      </div>
    </section>
  <% } %>

  <!-- Bottom CTA -->
  <section class="project-bottom-cta">
    <div class="container">
      <h2>Ready to Start Your Project?</h2>
      <p>Contact BuildPro Demo Co for a free estimate on your next project.</p>
      <div class="cta-buttons">
        <a href="/#contact" class="btn btn-primary btn-lg">Get Free Estimate</a>
        <a href="tel:5551234567" class="btn btn-outline-light btn-lg">Call (555) 123-4567</a>
      </div>
    </div>
  </section>

  <!-- Lightbox -->
  <div class="lightbox" id="lightbox" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:10000;align-items:center;justify-content:center;">
    <button class="lightbox-close" id="lightbox-close" aria-label="Close" style="position:fixed;top:20px;right:20px;z-index:10002;background:rgba(255,255,255,0.15);border:2px solid rgba(255,255,255,0.4);color:#fff;width:52px;height:52px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:28px;line-height:1;transition:background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
    
    <% if (images.length > 1) { %>
      <button class="lightbox-nav prev" onclick="event.stopPropagation(); prevImage()" aria-label="Previous" style="position:fixed;left:15px;top:50%;transform:translateY(-50%);z-index:10001;background:rgba(255,255,255,0.15);border:none;color:#fff;width:48px;height:48px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </button>
      <button class="lightbox-nav next" onclick="event.stopPropagation(); nextImage()" aria-label="Next" style="position:fixed;right:15px;top:50%;transform:translateY(-50%);z-index:10001;background:rgba(255,255,255,0.15);border:none;color:#fff;width:48px;height:48px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </button>
    <% } %>

    <div class="lightbox-content" onclick="event.stopPropagation()" style="display:flex;flex-direction:column;align-items:center;justify-content:center;max-width:90vw;max-height:90vh;">
      <img id="lightbox-image" src="" alt="" style="max-width:90vw;max-height:80vh;object-fit:contain;">
      <div class="lightbox-footer" style="text-align:center;color:#fff;padding:12px 0;">
        <p class="lightbox-caption" id="lightbox-caption" style="margin:0;font-size:14px;opacity:0.8;"></p>
        <% if (images.length > 1) { %>
          <span class="lightbox-counter" id="lightbox-counter" style="font-size:13px;opacity:0.6;"></span>
        <% } %>
      </div>
    </div>
  </div>

  <!-- Lightbox JavaScript -->
  <script>
    const images = <%- JSON.stringify(images) %>;
    let currentImageIndex = 0;

    function openLightbox(index) {
      currentImageIndex = index;
      const lightbox = document.getElementById('lightbox');
      lightbox.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      updateLightboxImage();
    }

    function closeLightbox() {
      const lightbox = document.getElementById('lightbox');
      lightbox.style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    function nextImage() {
      if (images.length === 0) return;
      currentImageIndex = currentImageIndex === images.length - 1 ? 0 : currentImageIndex + 1;
      updateLightboxImage();
    }

    function prevImage() {
      if (images.length === 0) return;
      currentImageIndex = currentImageIndex === 0 ? images.length - 1 : currentImageIndex - 1;
      updateLightboxImage();
    }

    function updateLightboxImage() {
      var img = document.getElementById('lightbox-image');
      var caption = document.getElementById('lightbox-caption');
      var counter = document.getElementById('lightbox-counter');
      
      if (images[currentImageIndex]) {
        img.src = images[currentImageIndex].url;
        img.alt = images[currentImageIndex].caption || 'Image ' + (currentImageIndex + 1);
        
        if (caption) {
          caption.textContent = images[currentImageIndex].caption || '';
          caption.style.display = images[currentImageIndex].caption ? 'block' : 'none';
        }
        
        if (counter) {
          counter.textContent = (currentImageIndex + 1) + ' / ' + images.length;
        }
      }
    }

    // Close button click
    document.getElementById('lightbox-close').addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      closeLightbox();
    });

    // Backdrop click (close when clicking outside image)
    document.getElementById('lightbox').addEventListener('click', function(e) {
      // Only close if clicking the backdrop itself, not children
      if (e.target === this) {
        closeLightbox();
      }
    });

    // Keyboard navigation
    document.addEventListener('keydown', function(e) {
      var lightbox = document.getElementById('lightbox');
      if (lightbox.style.display !== 'flex') return;
      
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowRight') nextImage();
      if (e.key === 'ArrowLeft') prevImage();
    });
  </script>

  <!-- Project Schema -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "CreativeWork",
    "name": "<%= project.title.replace(/"/g, '\\"') %>",
    "description": "<%= (project.description || '').replace(/"/g, '\\"').substring(0, 200) %>",
    <% if (images.length > 0) { %>
      "image": [
        <% images.forEach((image, index) => { %>
          "<%= image.url %>"<%= index < images.length - 1 ? ',' : '' %>
        <% }); %>
      ],
    <% } %>
    "creator": {
      "@type": "HomeAndConstructionBusiness",
      "name": "BuildPro Demo Co",
      "url": "https://buildpro-demo-site.onrender.com",
      "telephone": "(555) 123-4567"
    },
    "locationCreated": {
      "@type": "Place",
      "address": {
        "@type": "PostalAddress",
        "addressLocality": "<%= project.location ? project.location.split(',')[0].trim() : 'Austin' %>",
        "addressRegion": "WI"
      }
    }<% if (project.category) { %>,
    "about": {
      "@type": "Service",
      "serviceType": "<%= project.category %>"
    }
    <% } %>
  }
  </script>
</div>
