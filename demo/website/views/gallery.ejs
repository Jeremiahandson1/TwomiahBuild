<%
  // Extract data from locals
  const projects = locals.projects || [];
  const categories = [...new Set(projects.map(p => p.category))].filter(Boolean);
  
  // Helper to get cover image
  function getCoverImage(project) {
    if (project.images && project.images.length > 0) {
      return project.images[0].thumbnail || project.images[0].url;
    }
    return null;
  }
%>

<div class="gallery-page">
  <!-- Hero Section -->
  <section class="gallery-hero">
    <div class="gallery-hero-bg"></div>
    <div class="gallery-hero-content">
      <div class="container">
        <h1>Our Work</h1>
        <p>Browse our portfolio of completed projects throughout the Greater Austin Area</p>
      </div>
    </div>
  </section>

  <!-- Filter Bar -->
  <section class="gallery-filters">
    <div class="container">
      <div class="filter-buttons">
        <button class="filter-btn active" data-filter="all">
          All Projects
        </button>
        <% categories.forEach(cat => { %>
          <button class="filter-btn" data-filter="<%= cat %>">
            <%= cat %>
          </button>
        <% }); %>
      </div>
      <div class="results-count">
        <span id="results-count"><%= projects.length %></span> project<span id="results-plural"><%= projects.length !== 1 ? 's' : '' %></span>
      </div>
    </div>
  </section>

  <!-- Projects Grid -->
  <section class="gallery-grid-section">
    <div class="container">
      <div class="gallery-grid" id="gallery-grid">
        <% if (projects.length === 0) { %>
          <div class="gallery-empty">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <circle cx="8.5" cy="8.5" r="1.5"></circle>
              <polyline points="21 15 16 10 5 21"></polyline>
            </svg>
            <h3>No projects found</h3>
            <p>Check back soon for new projects</p>
          </div>
        <% } else { %>
          <% projects.forEach(project => { 
            const coverImage = getCoverImage(project);
            const imageCount = project.images ? project.images.length : 0;
          %>
            <a 
              href="/gallery/<%= project.id %>" 
              class="gallery-card"
              data-category="<%= project.category || 'uncategorized' %>"
            >
              <div class="gallery-card-image">
                <% if (coverImage) { %>
                  <img 
                    src="<%= coverImage %>" 
                    alt="<%= project.title %>"
                    loading="lazy"
                  >
                <% } else { %>
                  <div class="gallery-card-placeholder">
                    <span><%= project.category || 'Project' %></span>
                  </div>
                <% } %>
                <div class="gallery-card-overlay">
                  <span class="view-btn">View Project</span>
                </div>
                <% if (imageCount > 1) { %>
                  <span class="photo-count">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                      <circle cx="8.5" cy="8.5" r="1.5"></circle>
                      <polyline points="21 15 16 10 5 21"></polyline>
                    </svg>
                    <%= imageCount %>
                  </span>
                <% } %>
              </div>
              <div class="gallery-card-content">
                <span class="project-category"><%= project.category %></span>
                <h3><%= project.title %></h3>
                <% if (project.location) { %>
                  <p class="project-location">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                      <circle cx="12" cy="10" r="3"></circle>
                    </svg>
                    <%= project.location %>
                  </p>
                <% } %>
              </div>
            </a>
          <% }); %>
        <% } %>
      </div>

      <!-- Empty State (hidden by default, shown by JS when filter returns no results) -->
      <div class="gallery-empty" id="empty-state" style="display: none;">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <circle cx="8.5" cy="8.5" r="1.5"></circle>
          <polyline points="21 15 16 10 5 21"></polyline>
        </svg>
        <h3>No projects found</h3>
        <p>Try selecting a different category</p>
      </div>
    </div>
  </section>

  <!-- CTA Section -->
  <section class="gallery-cta">
    <div class="container">
      <div class="cta-content">
        <h2>Ready to Start Your Project?</h2>
        <p>Contact us today for a free estimate on your next project.</p>
        <div class="cta-buttons">
          <a href="/#contact" class="btn btn-primary btn-lg">Get Free Estimate</a>
          <a href="tel:5551234567" class="btn btn-outline-light btn-lg">Call (555) 123-4567</a>
        </div>
      </div>
    </div>
  </section>

  <!-- Gallery Schema -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "ImageGallery",
    "name": "BuildPro Demo Co Project Gallery",
    "description": "Browse our portfolio of completed projects in Austin and the Greater Austin Area",
    "url": "https://buildpro-demo-site.onrender.com/gallery",
    "image": [
      <% projects.slice(0, 10).forEach((project, index) => { 
        const img = getCoverImage(project);
        if (img) { %>
        "<%= img %>"<%= index < Math.min(projects.length - 1, 9) && getCoverImage(projects[index + 1]) ? ',' : '' %>
      <% } %>
      <% }); %>
    ]
  }
  </script>

  <!-- Client-Side Filtering JavaScript -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const filterButtons = document.querySelectorAll('.filter-btn');
      const galleryCards = document.querySelectorAll('.gallery-card');
      const resultsCount = document.getElementById('results-count');
      const resultsPlural = document.getElementById('results-plural');
      const emptyState = document.getElementById('empty-state');
      const galleryGrid = document.getElementById('gallery-grid');

      filterButtons.forEach(button => {
        button.addEventListener('click', () => {
          const filter = button.getAttribute('data-filter');
          
          // Update active state
          filterButtons.forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
          
          // Filter cards
          let visibleCount = 0;
          galleryCards.forEach(card => {
            const category = card.getAttribute('data-category');
            if (filter === 'all' || category === filter) {
              card.style.display = 'block';
              visibleCount++;
            } else {
              card.style.display = 'none';
            }
          });
          
          // Update results count
          if (resultsCount) {
            resultsCount.textContent = visibleCount;
          }
          if (resultsPlural) {
            resultsPlural.textContent = visibleCount !== 1 ? 's' : '';
          }
          
          // Show/hide empty state
          if (emptyState) {
            if (visibleCount === 0) {
              galleryGrid.style.display = 'none';
              emptyState.style.display = 'flex';
            } else {
              galleryGrid.style.display = 'grid';
              emptyState.style.display = 'none';
            }
          }
        });
      });
    });
  </script>
</div>
