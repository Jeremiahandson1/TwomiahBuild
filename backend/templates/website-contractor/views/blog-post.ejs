<%
const phone = (typeof settings !== 'undefined' && settings && settings.phone) ? settings.phone : '{{COMPANY_PHONE}}';
const phoneRaw = phone.replace(/\D/g, '');

function getImageUrl(p) {
  if (!p) return '';
  if (p.startsWith('http')) return p;
  if (p.startsWith('/')) return p;
  return '/uploads/' + p;
}

function formatDate(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr);
  return d.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
}

function estimateReadTime(content) {
  if (!content) return '3 min read';
  const text = content.replace(/<[^>]+>/g, '');
  const words = text.split(/\s+/).length;
  const minutes = Math.max(1, Math.round(words / 225));
  return minutes + ' min read';
}

// Related services from allServices
const related = (typeof allServices !== 'undefined' && Array.isArray(allServices) && post.relatedServices)
  ? allServices.filter(s => post.relatedServices.includes(s.slug) || post.relatedServices.includes(s.id))
  : [];

// Other posts (excluding current)
const otherPosts = (typeof allPosts !== 'undefined' && Array.isArray(allPosts))
  ? allPosts.filter(p => p.published && p.id !== post.id).slice(0, 3)
  : [];
%>

<!-- Article Schema -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": "<%= post.title %>",
  "description": "<%= (post.excerpt || '').replace(/"/g, '\\"') %>",
  "datePublished": "<%= post.publishedAt %>",
  "author": {
    "@type": "Organization",
    "name": "{{COMPANY_NAME}}",
    "url": "{{SITE_URL}}"
  },
  "publisher": {
    "@type": "Organization",
    "name": "{{COMPANY_NAME}}",
    "url": "{{SITE_URL}}"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "{{SITE_URL}}/blog/<%= post.slug %>"
  }
}
</script>

<div class="blog-post-page">
  <!-- Hero -->
  <section class="post-hero">
    <div class="container">
      <a href="/blog" class="back-link">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
        All Articles
      </a>
      <div class="post-meta-top">
        <span class="post-category"><%= post.category || 'article' %></span>
        <span class="post-date"><%= formatDate(post.publishedAt) %></span>
        <span class="post-read-time"><%= estimateReadTime(post.content) %></span>
      </div>
      <h1><%= post.title %></h1>
    </div>
  </section>

  <!-- Content -->
  <section class="post-content-section">
    <div class="container">
      <div class="post-layout">
        <!-- Main Content -->
        <article class="post-content">
          <% if (post.image) { %>
            <div class="post-featured-image">
              <img src="<%= getImageUrl(post.image) %>" alt="<%= post.title %>">
            </div>
          <% } %>
          <div class="prose">
            <%- post.content %>
          </div>

          <% if (post.tags && post.tags.length > 0) { %>
            <div class="post-tags">
              <% post.tags.forEach(function(tag) { %>
                <span class="tag"><%= tag %></span>
              <% }); %>
            </div>
          <% } %>
        </article>

        <!-- Sidebar -->
        <aside class="post-sidebar">
          <!-- CTA -->
          <div class="sidebar-cta">
            <h3>Ready to Get Started?</h3>
            <p>Free estimates, honest advice.</p>
            <a href="tel:<%= phoneRaw %>" class="phone-link">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
              </svg>
              <%= phone %>
            </a>
            <a href="/#contact" class="btn btn-primary btn-block">Request Estimate</a>
          </div>

          <!-- Related Services -->
          <% if (related.length > 0) { %>
            <div class="sidebar-services">
              <h3>Related Services</h3>
              <ul>
                <% related.forEach(function(service) { %>
                  <li>
                    <a href="/<%= service.urlSlug || service.id %>">
                      <span class="service-icon-small"><%= service.icon || 'ðŸ”§' %></span>
                      <span><%= service.title %></span>
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"></polyline>
                      </svg>
                    </a>
                  </li>
                <% }); %>
              </ul>
            </div>
          <% } %>
        </aside>
      </div>
    </div>
  </section>

  <!-- More Articles -->
  <% if (otherPosts.length > 0) { %>
    <section class="more-posts-section">
      <div class="container">
        <h2>More Articles</h2>
        <div class="more-posts-grid">
          <% otherPosts.forEach(function(other) { %>
            <a href="/blog/<%= other.slug %>" class="more-post-card">
              <span class="more-post-category"><%= other.category || 'article' %></span>
              <h3><%= other.title %></h3>
              <p><%= other.excerpt %></p>
              <span class="blog-read-more">Read Article â†’</span>
            </a>
          <% }); %>
        </div>
      </div>
    </section>
  <% } %>

  <!-- Bottom CTA -->
  <section class="post-bottom-cta">
    <div class="container">
      <h2>Questions? Let's Talk.</h2>
      <p>No pressure, no sales tactics â€” just honest answers from our team.</p>
      <div class="hero-buttons">
        <a href="/#contact" class="btn btn-primary btn-lg">Get a Free Estimate</a>
        <a href="tel:<%= phoneRaw %>" class="btn btn-outline btn-lg">Call <%= phone %></a>
      </div>
    </div>
  </section>
</div>

<style>
.blog-post-page .post-hero {
  background: var(--dark-bg, #1a1a2e);
  color: white;
  padding: 80px 0 50px;
}
.blog-post-page .back-link {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  color: rgba(255,255,255,0.7);
  text-decoration: none;
  font-size: 0.9rem;
  margin-bottom: 20px;
}
.blog-post-page .back-link:hover { color: white; }
.post-meta-top {
  display: flex;
  gap: 16px;
  align-items: center;
  margin-bottom: 16px;
  flex-wrap: wrap;
}
.post-category {
  background: var(--accent, #c8963e);
  color: white;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 600;
  text-transform: uppercase;
}
.post-date, .post-read-time {
  font-size: 0.9rem;
  opacity: 0.75;
}
.post-hero h1 {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 2.8rem;
  line-height: 1.1;
  max-width: 800px;
}

.post-content-section {
  padding: 50px 0;
}
.post-layout {
  display: grid;
  grid-template-columns: 1fr 320px;
  gap: 50px;
  align-items: start;
}
.post-content .prose {
  font-size: 1.05rem;
  line-height: 1.8;
  color: #333;
}
.post-content .prose h2 {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 1.8rem;
  color: var(--dark-bg, #1a1a2e);
  margin-top: 40px;
  margin-bottom: 16px;
}
.post-content .prose p {
  margin-bottom: 18px;
}
.post-content .prose a {
  color: var(--accent, #c8963e);
  font-weight: 500;
}
.post-content .prose a:hover { text-decoration: underline; }
.post-content .prose ul, .post-content .prose ol {
  margin: 16px 0;
  padding-left: 24px;
}
.post-content .prose li {
  margin-bottom: 8px;
  line-height: 1.6;
}
.post-content .prose strong { color: #111; }
.post-featured-image {
  margin-bottom: 30px;
  border-radius: 12px;
  overflow: hidden;
}
.post-featured-image img {
  width: 100%;
  height: auto;
}
.post-tags {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 40px;
  padding-top: 24px;
  border-top: 1px solid #e5e5e5;
}
.tag {
  background: #f0f0f0;
  color: #555;
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 0.8rem;
}

/* Sidebar */
.post-sidebar {
  position: sticky;
  top: 100px;
}
.sidebar-cta {
  background: var(--dark-bg, #1a1a2e);
  color: white;
  padding: 28px;
  border-radius: 12px;
  margin-bottom: 24px;
}
.sidebar-cta h3 {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 1.4rem;
  margin-bottom: 6px;
}
.sidebar-cta p {
  opacity: 0.8;
  font-size: 0.9rem;
  margin-bottom: 16px;
}
.sidebar-cta .phone-link {
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--accent, #c8963e);
  text-decoration: none;
  font-weight: 600;
  font-size: 1.1rem;
  margin-bottom: 16px;
}
.sidebar-cta .btn-block {
  display: block;
  text-align: center;
  width: 100%;
}

.sidebar-services {
  background: white;
  border: 1px solid #e5e5e5;
  border-radius: 12px;
  padding: 24px;
}
.sidebar-services h3 {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 1.3rem;
  margin-bottom: 16px;
  color: var(--dark-bg, #1a1a2e);
}
.sidebar-services ul {
  list-style: none;
  padding: 0;
  margin: 0;
}
.sidebar-services li a {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 0;
  text-decoration: none;
  color: #333;
  border-bottom: 1px solid #f0f0f0;
  transition: color 0.15s;
}
.sidebar-services li:last-child a { border-bottom: none; }
.sidebar-services li a:hover { color: var(--accent, #c8963e); }
.sidebar-services li a svg { margin-left: auto; opacity: 0.4; }
.service-icon-small { font-size: 1.2rem; }

/* More Articles */
.more-posts-section {
  padding: 50px 0;
  background: #f8f8f8;
}
.more-posts-section h2 {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 2rem;
  margin-bottom: 30px;
  color: var(--dark-bg, #1a1a2e);
}
.more-posts-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 24px;
}
.more-post-card {
  background: white;
  padding: 28px;
  border-radius: 12px;
  text-decoration: none;
  color: inherit;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  transition: transform 0.2s, box-shadow 0.2s;
  display: flex;
  flex-direction: column;
}
.more-post-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.1);
}
.more-post-category {
  background: var(--accent, #c8963e);
  color: white;
  padding: 3px 10px;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  align-self: flex-start;
  margin-bottom: 12px;
}
.more-post-card h3 {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 1.3rem;
  color: var(--dark-bg, #1a1a2e);
  margin-bottom: 8px;
  line-height: 1.2;
}
.more-post-card p {
  color: #666;
  font-size: 0.9rem;
  line-height: 1.5;
  flex: 1;
}
.more-post-card .blog-read-more {
  color: var(--accent, #c8963e);
  font-weight: 600;
  font-size: 0.85rem;
  margin-top: 14px;
}

/* Bottom CTA */
.post-bottom-cta {
  background: var(--dark-bg, #1a1a2e);
  color: white;
  padding: 60px 0;
  text-align: center;
}
.post-bottom-cta h2 {
  font-family: 'Bebas Neue', sans-serif;
  font-size: 2.2rem;
  margin-bottom: 10px;
}
.post-bottom-cta p {
  opacity: 0.85;
  margin-bottom: 24px;
}

@media (max-width: 900px) {
  .post-layout {
    grid-template-columns: 1fr;
  }
  .post-sidebar {
    position: static;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }
  .post-hero h1 { font-size: 2rem; }
}
@media (max-width: 600px) {
  .post-sidebar { grid-template-columns: 1fr; }
  .more-posts-grid { grid-template-columns: 1fr; }
}
</style>
