<%
  // Extract data from locals
  const pageData = locals.subService || {};
  const parentService = locals.service || {};
  const galleryProjects = locals.galleryProjects || [];
  const allServices = locals.allServices || [];
  const otherSubServices = (parentService.subServices || []).filter(s => s.id !== pageData.id);
  
  // Dynamic phone from settings
  const phone = (typeof settings !== 'undefined' && settings && settings.phone) ? settings.phone : '{{COMPANY_PHONE}}';
  const phoneRaw = phone.replace(/\D/g, '');

  // Hero settings
  const heroImage = pageData.heroImage || '';
  const heroAnimation = pageData.heroAnimation || 'none';
  const heroAnimationSpeed = pageData.heroAnimationSpeed || 10;
  
  // Function to get image URL
  function getImageUrl(p) {
    if (!p) return '';
    if (p.startsWith('http')) return p;
    if (p.startsWith('/')) return p;
    return '/uploads/' + p;
  }

  // Helper for content rendering
  function renderContent(content) {
    if (!content) return '';
    if (typeof content === 'string' && content.includes('<')) {
      return content;
    }
    return content.split('\n\n').map(para => `<p>${para}</p>`).join('');
  }
%>

<div class="service-page sub-service-page">
  <!-- Hero Section -->
  <section class="service-hero <%= heroImage ? 'has-image' : '' %>" style="--hero-speed: <%= heroAnimationSpeed %>s;">
    <% if (heroImage) { %>
      <div class="service-hero-bg animation-<%= heroAnimation %>" style="background-image: url('<%= getImageUrl(heroImage) %>');"></div>
      <div class="service-hero-overlay"></div>
    <% } %>
    <div class="service-hero-content">
      <div class="container">
        <a href="/<%= parentService.urlSlug || parentService.id %>" class="back-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
          Back to <%= parentService.title %>
        </a>
        <h1><%= pageData.title %></h1>
        <% if (pageData.tagline) { %>
          <p class="hero-tagline"><%= pageData.tagline %></p>
        <% } %>
        <% if (pageData.heroDescription) { %>
          <p class="hero-description"><%= pageData.heroDescription %></p>
        <% } %>
        <div class="hero-buttons">
          <a href="/#contact" class="btn btn-primary btn-lg">Get Free Estimate</a>
          <a href="tel:<%= phoneRaw %>" class="btn btn-outline-light btn-lg">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
            </svg>
            <%= phone %>
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Main Content -->
  <section class="service-main">
    <div class="container">
      <div class="service-layout">
        <!-- Main Column -->
        <div class="service-content">
          <div class="content-section">
            <h2><%= pageData.title %> Services in {{CITY}}</h2>
            <% if (pageData.description || pageData.content) { %>
              <div class="prose"><%- renderContent(pageData.description || pageData.content) %></div>
            <% } %>
          </div>

          <!-- Services Offered -->
          <% if (pageData.offerings && pageData.offerings.length > 0) { %>
            <div class="offerings-section">
              <h2>Our <%= pageData.title %> Options</h2>
              <div class="offerings-grid">
                <% pageData.offerings.forEach((offering, index) => { %>
                  <div class="offering-card">
                    <div class="offering-number"><%= String(index + 1).padStart(2, '0') %></div>
                    <h3><%= offering.title %></h3>
                    <p><%= offering.description %></p>
                  </div>
                <% }); %>
              </div>
            </div>
          <% } %>

          <!-- Materials & Features -->
          <% if ((pageData.materials && pageData.materials.length > 0) || (pageData.features && pageData.features.length > 0)) { %>
            <div class="details-section">
              <div class="details-grid">
                <% if (pageData.materials && pageData.materials.length > 0) { %>
                  <div class="details-card">
                    <h3>
                      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                        <line x1="7" y1="7" x2="7.01" y2="7"></line>
                      </svg>
                      Materials We Use
                    </h3>
                    <ul>
                      <% pageData.materials.forEach(material => { %>
                        <li>
                          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                          </svg>
                          <%= material %>
                        </li>
                      <% }); %>
                    </ul>
                  </div>
                <% } %>

                <% if (pageData.features && pageData.features.length > 0) { %>
                  <div class="details-card">
                    <h3>
                      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                      </svg>
                      Why Choose Us
                    </h3>
                    <ul>
                      <% pageData.features.forEach(feature => { %>
                        <li>
                          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                          </svg>
                          <%= feature %>
                        </li>
                      <% }); %>
                    </ul>
                  </div>
                <% } %>
              </div>
            </div>
          <% } %>
        </div>

        <!-- Sidebar -->
        <aside class="service-sidebar">
          <div class="cta-card">
            <h3>Ready to Get Started?</h3>
            <p>Contact us today for a free, no-obligation estimate.</p>
            <a href="tel:<%= phoneRaw %>" class="phone-link">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
              </svg>
              <%= phone %>
            </a>
            <a href="/#contact" class="btn btn-primary btn-block">Request Estimate</a>
          </div>

          <div class="trust-card">
            <div class="trust-item">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
              </svg>
              <span>Licensed & Insured</span>
            </div>
            <div class="trust-item">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="8" r="7"></circle>
                <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline>
              </svg>
              <span>Quality Guaranteed</span>
            </div>
            <div class="trust-item">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                <path d="M2 17l10 5 10-5"></path>
                <path d="M2 12l10 5 10-5"></path>
              </svg>
              <span>Expert Craftsmen</span>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </section>

  <!-- Related Projects -->
  <% if (galleryProjects.length > 0) { %>
    <section class="service-projects">
      <div class="container">
        <div class="section-header">
          <h2>Recent <%= parentService.title %> Projects</h2>
          <a href="/gallery" class="view-all-link">View All Projects â†’</a>
        </div>
        <div class="projects-grid">
          <% galleryProjects.forEach(project => { %>
            <a href="/gallery/<%= project.id %>" class="project-card">
              <div class="project-image">
                <% if (project.images && project.images[0]) { %>
                  <img src="<%= getImageUrl(project.images[0].thumbnail || project.images[0].url) %>" alt="<%= project.title %>">
                <% } else { %>
                  <div class="project-placeholder">
                    <span><%= project.category %></span>
                  </div>
                <% } %>
                <div class="project-overlay">
                  <span>View Project</span>
                </div>
              </div>
              <div class="project-info">
                <h3><%= project.title %></h3>
                <% if (project.location) { %>
                  <p><%= project.location %></p>
                <% } %>
              </div>
            </a>
          <% }); %>
        </div>
      </div>
    </section>
  <% } %>

  <!-- FAQ Section -->
  <% if (pageData.faqs && pageData.faqs.length > 0) { %>
    <section class="service-faq">
      <div class="container">
        <h2>Frequently Asked Questions</h2>
        <div class="faq-list">
          <% pageData.faqs.forEach((faq, index) => { %>
            <div class="faq-item" data-faq-index="<%= index %>">
              <button class="faq-question">
                <span><%= faq.question %></span>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
              </button>
              <div class="faq-answer">
                <p><%= faq.answer %></p>
              </div>
            </div>
          <% }); %>
        </div>
      </div>

      <!-- FAQ Schema -->
      <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "FAQPage",
        "mainEntity": [
          <% pageData.faqs.forEach((faq, i) => { %>
            {
              "@type": "Question",
              "name": <%- JSON.stringify(faq.question || '') %>,
              "acceptedAnswer": {
                "@type": "Answer",
                "text": <%- JSON.stringify(faq.answer || '') %>
              }
            }<%= i < pageData.faqs.length - 1 ? ',' : '' %>
          <% }); %>
        ]
      }
      </script>
    </section>

    <script>
      // FAQ accordion functionality
      document.addEventListener('DOMContentLoaded', function() {
        const faqItems = document.querySelectorAll('.faq-item');
        
        faqItems.forEach(item => {
          const button = item.querySelector('.faq-question');
          
          button.addEventListener('click', () => {
            const isOpen = item.classList.contains('open');
            
            // Close all other FAQs
            faqItems.forEach(i => i.classList.remove('open'));
            
            // Toggle current FAQ
            if (!isOpen) {
              item.classList.add('open');
            }
          });
        });
      });
    </script>
  <% } %>

  <!-- Bottom CTA -->
  <section class="service-cta">
    <div class="container">
      <h2>Ready to Start Your <%= pageData.title %> Project?</h2>
      <p>Contact {{COMPANY_NAME}} today for a free estimate. We serve {{CITY}} and the surrounding {{SERVICE_REGION}} area.</p>
      <div class="cta-buttons">
        <a href="/#contact" class="btn btn-primary btn-lg">Get Free Estimate</a>
        <a href="tel:<%= phoneRaw %>" class="btn btn-outline-light btn-lg">Call <%= phone %></a>
      </div>
    </div>
  </section>

  <!-- Other Sub-Services -->
  <% if (otherSubServices.length > 0) { %>
    <section class="other-services sub-services">
      <div class="container">
        <h3>More <%= parentService.title %> Services</h3>
        <div class="services-links">
          <% otherSubServices.forEach(sub => { %>
            <a href="/<%= parentService.urlSlug || parentService.id %>/<%= sub.id %>" class="service-link">
              <%= sub.title %>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </a>
          <% }); %>
        </div>
      </div>
    </section>
  <% } %>

  <!-- Other Main Services -->
  <section class="other-services">
    <div class="container">
      <h3>Explore Our Other Services</h3>
      <div class="services-links">
        <% allServices.filter(s => s.id !== parentService.id).forEach(s => { %>
          <a href="/<%= s.urlSlug || s.id %>" class="service-link">
            <%= s.title %>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </a>
        <% }); %>
      </div>
    </div>
  </section>

  <!-- Service Schema -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Service",
    "serviceType": <%- JSON.stringify(pageData.title || '') %>,
    "provider": {
      "@type": "HomeAndConstructionBusiness",
      "name": "{{COMPANY_NAME}}",
      "url": "{{SITE_URL}}",
      "telephone": "+1<%= phoneRaw %>",
      "areaServed": {
        "@type": "City",
        "name": "{{CITY}}",
        "containedInPlace": {
          "@type": "State",
          "name": "{{STATE_FULL}}"
        }
      }
    },
    "category": <%- JSON.stringify(parentService.title || '') %>,
    "description": <%- JSON.stringify(pageData.tagline || pageData.heroDescription || '') %>
  }
  </script>
</div>
