generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== MULTI-TENANT ====================
model Company {
  id              String   @id @default(cuid())
  name            String
  slug            String   @unique
  email           String?
  phone           String?
  address         String?
  city            String?
  state           String?
  zip             String?
  logo            String?
  primaryColor    String   @default("#f97316")
  secondaryColor  String?
  website         String?
  licenseNumber   String?
  enabledFeatures String[] @default([])
  settings        Json     @default("{}")
  integrations    Json     @default("{}") // OAuth tokens, connected accounts

  // Stripe
  stripeCustomerId String? @unique
  subscriptionTier String?
  licenseType      String?
  lifetimeAccess   Boolean @default(false)

  // Twilio
  twilioPhoneNumber String?
  twilioAccountSid  String?
  twilioAuthToken   String?

  // Agency support
  isAgency  Boolean @default(false)
  agencyId  String?  // if this company is managed by an agency

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Core relations
  users          User[]
  contacts       Contact[]
  projects       Project[]
  jobs           Job[]
  quotes         Quote[]
  invoices       Invoice[]
  expenses       Expense[]
  timeEntries    TimeEntry[]
  dailyLogs      DailyLog[]
  rfis           RFI[]
  submittals     Submittal[]
  changeOrders   ChangeOrder[]
  punchListItems PunchListItem[]
  inspections    Inspection[]
  bids           Bid[]
  campaigns      Campaign[]
  messages       Message[]
  documents      Document[]
  teamMembers    TeamMember[]

  // SMS
  smsConversations SmsConversation[]
  smsTemplates     SmsTemplate[]
  scheduledSms     ScheduledSms[]
  emailLogs        EmailLog[]

  // GPS/Location
  locationLogs LocationLog[]
  geofences    Geofence[]

  // Inventory
  inventoryItems        InventoryItem[]
  inventoryLocations    InventoryLocation[]
  inventoryTransactions InventoryTransaction[]
  inventoryUsages       InventoryUsage[]
  inventoryTransfers    InventoryTransfer[]
  purchaseOrders        PurchaseOrder[]

  // Pricebook
  pricebookCategories PricebookCategory[]
  pricebookItems      PricebookItem[]
  pricebookRelations  PricebookRelation[]

  // Reviews
  reviewRequests ReviewRequest[]
  reviews        Review[]

  // Financing
  financingApplications FinancingApplication[]

  // Service Agreements
  serviceAgreements ServiceAgreement[]

  // Equipment
  equipment           Equipment[]
  equipmentCategories EquipmentCategory[]

  // Fleet
  vehicles Vehicle[]

  // Marketing
  emailTemplates EmailTemplate[]
  emailCampaigns EmailCampaign[]
  automations    Automation[]

  // Paid Ads
  adAccounts  AdAccount[]
  adCampaigns AdCampaign[]
  adReports   AdReport[]

  // Call Tracking
  trackingNumbers TrackingNumber[]
  phoneCalls      PhoneCall[]

  // Scheduling
  scheduleEvents     ScheduleEvent[]
  recurringSchedules RecurringSchedule[]

  // Selections
  selectionCategories SelectionCategory[]
  selectionItems      SelectionItem[]

  // Takeoffs
  takeoffs Takeoff[]

  // Warranties
  warranties     Warranty[]
  warrantyClaims WarrantyClaim[]

  // Billing
  subscription    Subscription?
  licenses        License[]
  addonPurchases  AddonPurchase[]
  usageRecords    UsageRecord[]
  billingInvoices BillingInvoice[]

  // Booking
  bookingSettings  BookingSettings?
  bookableServices BookableService[]
  onlineBookings   OnlineBooking[]

  // Custom Forms
  formTemplates   FormTemplate[]
  formSubmissions FormSubmission[]

  // Lien Waivers
  lienWaivers LienWaiver[]

  // Draw Schedules
  schedulesOfValues ScheduleOfValues[]
  drawRequests      DrawRequest[]

  // Audit
  auditLogs AuditLog[]

  // Factory
  factoryCustomers FactoryCustomer[]
  factoryBuilds    FactoryBuild[]
}

// ==================== USERS ====================
model User {
  id            String    @id @default(cuid())
  email         String
  passwordHash  String
  firstName     String
  lastName      String
  phone         String?
  avatar        String?
  role          String    @default("user")
  hourlyRate    Decimal?  @db.Decimal(10, 2)
  isActive      Boolean   @default(true)
  lastLogin     DateTime?
  refreshToken  String?
  resetToken    String?
  resetTokenExp DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  agencyId  String?  // set when user has agency_admin role

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  assignedJobs      Job[]       @relation("AssignedTo")
  createdJobs       Job[]       @relation("CreatedBy")
  timeEntries       TimeEntry[]
  dailyLogs         DailyLog[]
  messages          Message[]
  uploadedDocuments Document[]

  // SMS
  smsMessages         SmsMessage[]
  scheduledSmsCreated ScheduledSms[] @relation("ScheduledSmsCreatedBy")
  emailLogsSent       EmailLog[]     @relation("EmailLogsSentBy")

  // GPS/Location
  locationLogs   LocationLog[]
  geofenceEvents GeofenceEvent[]
  settings       UserSettings?

  // Inventory
  inventoryLocations    InventoryLocation[]
  inventoryTransactions InventoryTransaction[]
  inventoryUsages       InventoryUsage[]
  inventoryTransfers    InventoryTransfer[]
  purchaseOrders        PurchaseOrder[]

  // Schedule
  scheduleEvents ScheduleEvent[]

  // Forms
  formSubmissions FormSubmission[]

  // Lien Waivers
  approvedLienWaivers LienWaiver[] @relation("LienWaiverApproved")
  rejectedLienWaivers LienWaiver[] @relation("LienWaiverRejected")

  // Draw Schedules
  approvedDraws DrawRequest[] @relation("DrawApproved")
  rejectedDraws DrawRequest[] @relation("DrawRejected")

  @@unique([email, companyId])
  @@index([companyId])
}

// ==================== CRM ====================
model Contact {
  id           String   @id @default(cuid())
  type         String   @default("lead")
  name         String
  company      String?
  email        String?
  phone        String?
  mobile       String?
  address      String?
  city         String?
  state        String?
  zip          String?
  lat          Float?
  lng          Float?
  notes        String?
  source       String?
  tags         String[] @default([])
  customFields Json     @default("{}")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Portal access
  portalEnabled    Boolean   @default(false)
  portalToken      String?   @unique
  portalTokenExp   DateTime?
  lastPortalVisit  DateTime?
  stripeCustomerId String?

  companyId  String
  companyRef Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  projects              Project[]
  jobs                  Job[]
  quotes                Quote[]
  invoices              Invoice[]
  messages              Message[]
  documents             Document[]
  smsConversations      SmsConversation[]
  scheduledSms          ScheduledSms[]
  emailLogs             EmailLog[]             @relation("EmailLogs")
  reviewRequests        ReviewRequest[]
  reviews               Review[]
  financingApplications FinancingApplication[]
  serviceAgreements     ServiceAgreement[]
  onlineBookings        OnlineBooking[]
  formSubmissions       FormSubmission[]
  lienWaivers           LienWaiver[]
  selections            Selection[]

  @@index([companyId])
  @@index([type])
}

// ==================== PROJECTS ====================
model Project {
  id             String    @id @default(cuid())
  number         String
  name           String
  description    String?
  status         String    @default("planning")
  type           String?
  address        String?
  city           String?
  state          String?
  zip            String?
  lat            Float?
  lng            Float?
  startDate      DateTime?
  endDate        DateTime?
  estimatedValue Decimal?  @db.Decimal(12, 2)
  actualValue    Decimal?  @db.Decimal(12, 2)
  budget         Decimal?  @db.Decimal(12, 2)
  progress       Int       @default(0)
  notes          String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  companyId String
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)

  jobs             Job[]
  quotes           Quote[]
  invoices         Invoice[]
  expenses         Expense[]
  timeEntries      TimeEntry[]
  dailyLogs        DailyLog[]
  rfis             RFI[]
  submittals       Submittal[]
  changeOrders     ChangeOrder[]
  punchListItems   PunchListItem[]
  inspections      Inspection[]
  documents        Document[]
  geofences        Geofence[]
  takeoffs         Takeoff[]
  formSubmissions  FormSubmission[]
  lienWaivers      LienWaiver[]
  scheduleOfValues ScheduleOfValues?
  drawRequests     DrawRequest[]
  selections       Selection[]

  @@index([companyId])
  @@index([status])
}

// ==================== JOBS ====================
model Job {
  id               String    @id @default(cuid())
  number           String
  title            String
  description      String?
  status           String    @default("scheduled")
  priority         String    @default("normal")
  type             String?
  source           String?
  scheduledDate    DateTime?
  scheduledEndDate DateTime?
  scheduledTime    String?
  estimatedHours   Decimal?  @db.Decimal(5, 2)
  estimatedValue   Decimal?  @db.Decimal(12, 2)
  actualHours      Decimal?  @db.Decimal(5, 2)
  address          String?
  city             String?
  state            String?
  zip              String?
  lat              Float?
  lng              Float?
  geofenceRadius   Int?      @default(100)
  notes            String?
  internalNotes    String?
  completedAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  companyId    String
  company      Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  projectId    String?
  project      Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  contactId    String?
  contact      Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  assignedToId String?
  assignedTo   User?    @relation("AssignedTo", fields: [assignedToId], references: [id], onDelete: SetNull)
  createdById  String?
  createdBy    User?    @relation("CreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  quoteId      String?
  quote        Quote?   @relation(fields: [quoteId], references: [id], onDelete: SetNull)

  timeEntries           TimeEntry[]
  expenses              Expense[]
  documents             Document[]
  scheduledSms          ScheduledSms[]
  locationLogs          LocationLog[]
  geofence              Geofence?
  inventoryUsages       InventoryUsage[]
  inventoryTransactions InventoryTransaction[]
  onlineBookings        OnlineBooking[]
  formSubmissions       FormSubmission[]

  @@index([companyId])
  @@index([status])
  @@index([scheduledDate])
  @@index([assignedToId])
}

// ==================== QUOTES ====================
model Quote {
  id         String    @id @default(cuid())
  number     String
  name       String
  status     String    @default("draft")
  issueDate  DateTime  @default(now())
  expiryDate DateTime?
  subtotal   Decimal   @default(0) @db.Decimal(12, 2)
  taxRate    Decimal   @default(0) @db.Decimal(5, 2)
  taxAmount  Decimal   @default(0) @db.Decimal(12, 2)
  discount   Decimal   @default(0) @db.Decimal(12, 2)
  total      Decimal   @default(0) @db.Decimal(12, 2)
  notes      String?
  terms      String?
  sentAt     DateTime?
  viewedAt   DateTime?
  approvedAt DateTime?
  approvedBy String?
  signedBy   String?
  signedAt   DateTime?
  signature  String?
  approvalNotes   String?
  approvalIp      String?
  rejectionReason String?
  validUntil DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  companyId String
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  lineItems QuoteLineItem[]
  invoice   Invoice?
  jobs      Job[]

  @@index([companyId])
  @@index([status])
}

model QuoteLineItem {
  id          String  @id @default(cuid())
  description String
  type        String?
  quantity    Decimal @default(1) @db.Decimal(10, 2)
  unitPrice   Decimal @default(0) @db.Decimal(12, 2)
  total       Decimal @default(0) @db.Decimal(12, 2)
  sortOrder   Int     @default(0)

  quoteId String
  quote   Quote  @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
}

// ==================== INVOICES ====================
model Invoice {
  id         String    @id @default(cuid())
  number     String
  status     String    @default("draft")
  issueDate  DateTime  @default(now())
  dueDate    DateTime?
  subtotal   Decimal   @default(0) @db.Decimal(12, 2)
  taxRate    Decimal   @default(0) @db.Decimal(5, 2)
  taxAmount  Decimal   @default(0) @db.Decimal(12, 2)
  discount   Decimal   @default(0) @db.Decimal(12, 2)
  total      Decimal   @default(0) @db.Decimal(12, 2)
  amountPaid Decimal   @default(0) @db.Decimal(12, 2)
  notes      String?
  terms      String?
  sentAt     DateTime?
  paidAt     DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Stripe integration
  stripePaymentIntentId String? @unique
  stripePaymentLink     String?
  refundAmount          Decimal? @db.Decimal(12, 2)
  refundedAt            DateTime?

  companyId String
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  quoteId   String?  @unique
  quote     Quote?   @relation(fields: [quoteId], references: [id], onDelete: SetNull)

  lineItems InvoiceLineItem[]
  payments  Payment[]
  documents Document[]

  @@index([companyId])
  @@index([status])
}

model InvoiceLineItem {
  id          String  @id @default(cuid())
  description String
  type        String?
  quantity    Decimal @default(1) @db.Decimal(10, 2)
  unitPrice   Decimal @default(0) @db.Decimal(12, 2)
  total       Decimal @default(0) @db.Decimal(12, 2)
  sortOrder   Int     @default(0)

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

model Payment {
  id        String   @id @default(cuid())
  amount    Decimal  @db.Decimal(12, 2)
  method    String   @default("other")
  reference String?
  notes     String?
  paidAt    DateTime @default(now())
  createdAt DateTime @default(now())

  // Stripe integration
  stripePaymentIntentId String?
  stripeRefundId        String?
  refundAmount          Decimal? @db.Decimal(12, 2)
  refundedAt            DateTime?

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

// ==================== TIME & EXPENSES ====================
model TimeEntry {
  id            String    @id @default(cuid())
  date          DateTime  @default(now())
  hours         Decimal   @db.Decimal(5, 2)
  hourlyRate    Decimal?  @db.Decimal(10, 2)
  description   String?
  billable      Boolean   @default(true)
  approved      Boolean   @default(false)
  approvedAt    DateTime?
  isAutoClocked Boolean   @default(false)
  clockIn       DateTime?
  clockOut      DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  companyId String
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobId     String?
  job       Job?     @relation(fields: [jobId], references: [id], onDelete: SetNull)
  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([companyId])
  @@index([userId])
  @@index([jobId])
  @@index([date])
}

model Expense {
  id           String    @id @default(cuid())
  date         DateTime  @default(now())
  category     String
  vendor       String?
  description  String?
  amount       Decimal   @db.Decimal(12, 2)
  taxAmount    Decimal   @default(0) @db.Decimal(12, 2)
  receiptUrl   String?
  billable     Boolean   @default(true)
  reimbursable Boolean   @default(false)
  reimbursed   Boolean   @default(false)
  reimbursedAt DateTime?
  approved     Boolean   @default(false)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  companyId String
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  jobId     String?
  job       Job?     @relation(fields: [jobId], references: [id], onDelete: SetNull)

  @@index([companyId])
  @@index([projectId])
  @@index([jobId])
}

// ==================== CONSTRUCTION ====================
model DailyLog {
  id            String   @id @default(cuid())
  date          DateTime @default(now())
  weather       String?
  conditions    String?
  crewSize      Int?
  hoursWorked   Decimal?  @db.Decimal(10, 2)
  workPerformed String?
  materials     String?
  equipment     String?
  delays        String?
  safetyNotes   String?
  temperature   Int?
  workCompleted String?
  visitors      String?
  photos        String[] @default([])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  companyId     String
  company       Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  projectId     String
  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([companyId])
  @@index([projectId])
  @@index([date])
}

model RFI {
  id          String    @id @default(cuid())
  number      String
  subject     String
  question    String
  status      String    @default("open")
  priority    String    @default("normal")
  assignedTo  String?
  dueDate     DateTime?
  response    String?
  respondedAt DateTime?
  respondedBy String?
  closedAt    DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([projectId])
}

model Submittal {
  id            String    @id @default(cuid())
  number        String
  title         String
  description   String?
  status        String    @default("pending")
  specSection   String?
  dueDate       DateTime?
  submittedDate DateTime?
  approvedDate  DateTime?
  approvedBy    String?
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([projectId])
}

model ChangeOrder {
  id            String    @id @default(cuid())
  number        String
  title         String
  description   String?
  status        String    @default("draft")
  reason        String?
  amount        Decimal   @default(0) @db.Decimal(12, 2)
  daysAdded     Int       @default(0)
  submittedDate DateTime?
  approvedDate  DateTime?
  approvedBy    String?
  signature     String?
  signedBy      String?
  signedAt      DateTime?
  approvalNotes   String?
  approvalIp      String?
  rejectionReason String?
  rejectedAt      DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  lineItems ChangeOrderLineItem[]

  @@index([companyId])
  @@index([projectId])
}

model ChangeOrderLineItem {
  id          String  @id @default(cuid())
  description String
  quantity    Decimal @default(1) @db.Decimal(10, 2)
  unitPrice   Decimal @default(0) @db.Decimal(12, 2)
  total       Decimal @default(0) @db.Decimal(12, 2)
  sortOrder   Int     @default(0)

  changeOrderId String
  changeOrder   ChangeOrder @relation(fields: [changeOrderId], references: [id], onDelete: Cascade)

  @@index([changeOrderId])
}

model PunchListItem {
  id          String    @id @default(cuid())
  number      String
  description String
  location    String?
  status      String    @default("open")
  priority    String    @default("normal")
  assignedTo  String?
  dueDate     DateTime?
  completedAt DateTime?
  verifiedAt  DateTime?
  verifiedBy  String?
  photos      String[]  @default([])
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([projectId])
  @@index([status])
}

model Inspection {
  id            String    @id @default(cuid())
  number        String
  type          String
  status        String    @default("scheduled")
  scheduledDate DateTime?
  inspector     String?
  result        String?
  notes         String?
  deficiencies  String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([projectId])
}

// ==================== BIDDING ====================
model Bid {
  id             String    @id @default(cuid())
  number         String
  projectName    String
  client         String?
  status         String    @default("draft")
  bidType        String    @default("lump_sum")
  dueDate        DateTime?
  dueTime        String?
  estimatedValue Decimal?  @db.Decimal(12, 2)
  bidAmount      Decimal?  @db.Decimal(12, 2)
  bondRequired   Boolean   @default(false)
  prebidDate     DateTime?
  prebidLocation String?
  scope          String?
  notes          String?
  submittedAt    DateTime?
  resultDate     DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([status])
}

// ==================== MARKETING ====================
model Campaign {
  id             String    @id @default(cuid())
  name           String
  type           String    @default("email")
  subject        String?
  content        String?
  status         String    @default("draft")
  scheduledDate  DateTime?
  sentAt         DateTime?
  recipientCount Int       @default(0)
  openCount      Int       @default(0)
  clickCount     Int       @default(0)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
}

// ==================== COMMUNICATION ====================
model Message {
  id        String    @id @default(cuid())
  type      String    @default("email")
  direction String    @default("outbound")
  subject   String?
  body      String
  status    String    @default("draft")
  sentAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  companyId String
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([companyId])
  @@index([contactId])
}

// ==================== DOCUMENTS ====================
model Document {
  id           String   @id @default(cuid())
  name         String
  type         String   @default("general")
  filename     String
  originalName String
  mimeType     String?
  size         Int?
  path         String
  url          String
  thumbnailUrl String?
  description  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  companyId    String
  company      Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  projectId    String?
  project      Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  contactId    String?
  contact      Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  jobId        String?
  job          Job?     @relation(fields: [jobId], references: [id], onDelete: SetNull)
  invoiceId    String?
  invoice      Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  uploadedById String?
  uploadedBy   User?    @relation(fields: [uploadedById], references: [id], onDelete: SetNull)

  @@index([companyId])
  @@index([projectId])
  @@index([contactId])
  @@index([type])
}

// ==================== TEAM ====================
model TeamMember {
  id         String    @id @default(cuid())
  name       String
  email      String?
  phone      String?
  role       String?
  department String?
  hireDate   DateTime?
  hourlyRate Decimal?  @db.Decimal(10, 2)
  active     Boolean   @default(true)
  skills     String[]  @default([])
  notes      String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
}

// ==================== SMS ====================
model SmsConversation {
  id            String    @id @default(cuid())
  phoneNumber   String
  status        String    @default("active")
  unreadCount   Int       @default(0)
  lastMessageAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  companyId String
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)

  messages SmsMessage[]

  @@unique([companyId, phoneNumber])
  @@index([companyId, status])
}

model SmsMessage {
  id           String  @id @default(cuid())
  direction    String
  body         String
  status       String  @default("queued")
  twilioSid    String? @unique
  errorCode    String?
  errorMessage String?
  mediaUrls    Json?

  createdAt   DateTime  @default(now())
  sentAt      DateTime?
  deliveredAt DateTime?

  conversationId String
  conversation   SmsConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sentById       String?
  sentBy         User?           @relation(fields: [sentById], references: [id], onDelete: SetNull)

  @@index([conversationId, createdAt])
}

model SmsTemplate {
  id       String  @id @default(cuid())
  name     String
  body     String
  category String?
  active   Boolean @default(true)
  useCount Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, category])
}

model ScheduledSms {
  id           String    @id @default(cuid())
  to           String
  body         String
  scheduledFor DateTime
  status       String    @default("pending")
  sentAt       DateTime?
  errorMessage String?

  createdAt DateTime @default(now())

  companyId   String
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contactId   String?
  contact     Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  jobId       String?
  job         Job?     @relation(fields: [jobId], references: [id], onDelete: SetNull)
  createdById String?
  createdBy   User?    @relation("ScheduledSmsCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  @@index([companyId, scheduledFor, status])
}

model EmailLog {
  id           String    @id @default(cuid())
  to           String
  subject      String
  body         String?
  status       String    @default("queued") // queued, sent, delivered, failed
  sendgridId   String?
  errorMessage String?
  openedAt     DateTime?
  clickedAt    DateTime?

  createdAt DateTime  @default(now())
  sentAt    DateTime?

  companyId String
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contactId String?
  contact   Contact? @relation("EmailLogs", fields: [contactId], references: [id], onDelete: SetNull)
  sentById  String?
  sentBy    User?    @relation("EmailLogsSentBy", fields: [sentById], references: [id], onDelete: SetNull)

  // Optional references
  invoiceId String?
  quoteId   String?
  jobId     String?

  @@index([companyId, createdAt])
  @@index([contactId])
}

// ==================== GPS/LOCATION ====================
model LocationLog {
  id        String   @id @default(cuid())
  lat       Float
  lng       Float
  accuracy  Float?
  timestamp DateTime @default(now())
  action    String?

  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  jobId     String?
  job       Job?    @relation(fields: [jobId], references: [id], onDelete: SetNull)

  @@index([userId, companyId, timestamp])
  @@index([jobId])
}

model Geofence {
  id      String  @id @default(cuid())
  name    String
  lat     Float
  lng     Float
  radius  Int     @default(100)
  address String?
  active  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  companyId String
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  jobId     String?  @unique
  job       Job?     @relation(fields: [jobId], references: [id], onDelete: SetNull)
  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  events GeofenceEvent[]

  @@index([companyId, active])
}

model GeofenceEvent {
  id        String   @id @default(cuid())
  inside    Boolean
  lat       Float
  lng       Float
  accuracy  Float?
  distance  Float?
  timestamp DateTime @default(now())

  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  geofenceId String
  geofence   Geofence @relation(fields: [geofenceId], references: [id], onDelete: Cascade)

  @@index([userId, geofenceId, timestamp])
}

model UserSettings {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  locationTrackingEnabled   Boolean @default(false)
  autoClockEnabled          Boolean @default(false)
  backgroundTrackingEnabled Boolean @default(false)
  locationAccuracy          String  @default("high")
  trackingInterval          Int     @default(30)
  geofenceRadius            Int     @default(100)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==================== INVENTORY ====================
model InventoryItem {
  id          String  @id @default(cuid())
  sku         String
  name        String
  description String?
  category    String?

  unitCost  Decimal @default(0) @db.Decimal(10, 2)
  unitPrice Decimal @default(0) @db.Decimal(10, 2)
  unit      String  @default("each")

  minStockLevel   Int @default(0)
  reorderPoint    Int @default(0)
  reorderQuantity Int @default(0)

  vendor           String?
  vendorPartNumber String?
  barcode          String?
  imageUrl         String?
  taxable          Boolean @default(true)
  active           Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  stockLevels        StockLevel[]
  usageHistory       InventoryUsage[]
  transactions       InventoryTransaction[]
  purchaseOrderItems PurchaseOrderItem[]
  transfers          InventoryTransfer[]
  pricebookItems     PricebookItem[]

  @@unique([companyId, sku])
  @@index([companyId, category])
}

model InventoryLocation {
  id      String  @id @default(cuid())
  name    String
  type    String  @default("warehouse")
  address String?
  active  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  companyId      String
  company        Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  assignedUserId String?
  assignedUser   User?   @relation(fields: [assignedUserId], references: [id], onDelete: SetNull)

  stockLevels    StockLevel[]
  transactions   InventoryTransaction[]
  usages         InventoryUsage[]
  purchaseOrders PurchaseOrder[]
  transfersFrom  InventoryTransfer[]    @relation("TransferFrom")
  transfersTo    InventoryTransfer[]    @relation("TransferTo")

  @@index([companyId, type])
}

model StockLevel {
  id       String @id @default(cuid())
  quantity Int    @default(0)

  itemId     String
  item       InventoryItem     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  locationId String
  location   InventoryLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([itemId, locationId])
}

model InventoryTransaction {
  id               String   @id @default(cuid())
  type             String
  quantity         Int
  previousQuantity Int
  newQuantity      Int
  reason           String?
  cost             Decimal? @db.Decimal(10, 2)

  createdAt DateTime @default(now())

  companyId  String
  company    Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  itemId     String
  item       InventoryItem     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  locationId String
  location   InventoryLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)
  userId     String?
  user       User?             @relation(fields: [userId], references: [id], onDelete: SetNull)
  jobId      String?
  job        Job?              @relation(fields: [jobId], references: [id], onDelete: SetNull)

  @@index([companyId, createdAt])
}

model InventoryUsage {
  id               String  @id @default(cuid())
  quantity         Int
  returnedQuantity Int     @default(0)
  unitCost         Decimal @db.Decimal(10, 2)
  unitPrice        Decimal @db.Decimal(10, 2)
  totalCost        Decimal @db.Decimal(10, 2)
  totalPrice       Decimal @db.Decimal(10, 2)

  createdAt DateTime @default(now())

  companyId  String
  company    Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  jobId      String
  job        Job               @relation(fields: [jobId], references: [id], onDelete: Cascade)
  itemId     String
  item       InventoryItem     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  locationId String
  location   InventoryLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)
  userId     String?
  user       User?             @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([jobId])
}

model InventoryTransfer {
  id          String    @id @default(cuid())
  quantity    Int
  status      String    @default("pending")
  notes       String?
  completedAt DateTime?

  createdAt DateTime @default(now())

  companyId      String
  company        Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  itemId         String
  item           InventoryItem     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  fromLocationId String
  fromLocation   InventoryLocation @relation("TransferFrom", fields: [fromLocationId], references: [id], onDelete: Cascade)
  toLocationId   String
  toLocation     InventoryLocation @relation("TransferTo", fields: [toLocationId], references: [id], onDelete: Cascade)
  userId         String?
  user           User?             @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([companyId, status])
}

model PurchaseOrder {
  id           String    @id @default(cuid())
  number       String
  vendor       String
  vendorEmail  String?
  status       String    @default("draft")
  total        Decimal   @default(0) @db.Decimal(10, 2)
  notes        String?
  expectedDate DateTime?
  receivedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  companyId   String
  company     Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  locationId  String
  location    InventoryLocation @relation(fields: [locationId], references: [id], onDelete: Cascade)
  createdById String?
  createdBy   User?             @relation(fields: [createdById], references: [id], onDelete: SetNull)

  items PurchaseOrderItem[]

  @@unique([companyId, number])
}

model PurchaseOrderItem {
  id               String  @id @default(cuid())
  quantity         Int
  receivedQuantity Int     @default(0)
  unitCost         Decimal @db.Decimal(10, 2)
  totalCost        Decimal @db.Decimal(10, 2)

  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  itemId          String
  item            InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
}

// ==================== PRICEBOOK ====================
model PricebookCategory {
  id          String  @id @default(cuid())
  name        String
  description String?
  sortOrder   Int     @default(0)
  active      Boolean @default(true)

  companyId String
  company   Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  parentId  String?
  parent    PricebookCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children  PricebookCategory[] @relation("CategoryHierarchy")

  items PricebookItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
}

model PricebookItem {
  id          String  @id @default(cuid())
  name        String
  description String?
  type        String  @default("service")
  code        String?
  price       Decimal @db.Decimal(12, 2)
  cost        Decimal @default(0) @db.Decimal(12, 2)
  unit        String  @default("each")
  taxable     Boolean @default(true)
  active      Boolean @default(true)

  companyId       String
  company         Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  categoryId      String?
  category        PricebookCategory? @relation(fields: [categoryId], references: [id])
  inventoryItemId String?
  inventoryItem   InventoryItem?     @relation(fields: [inventoryItemId], references: [id])

  relationsAsSource PricebookRelation[] @relation("RelationSource")
  relationsAsTarget PricebookRelation[] @relation("RelationTarget")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([categoryId])
}

// AI-generated pairings: "when X is on a quote, suggest Y"
model PricebookRelation {
  id       String @id @default(cuid())
  strength Int    @default(50)

  companyId    String
  company      Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sourceItemId String
  sourceItem   PricebookItem @relation("RelationSource", fields: [sourceItemId], references: [id], onDelete: Cascade)
  targetItemId String
  targetItem   PricebookItem @relation("RelationTarget", fields: [targetItemId], references: [id], onDelete: Cascade)

  reason  String?
  builtAt DateTime @default(now())

  @@unique([companyId, sourceItemId, targetItemId])
  @@index([companyId, sourceItemId])
}

// ==================== REVIEWS ====================
model ReviewRequest {
  id          String    @id @default(cuid())
  status      String    @default("pending")
  sentAt      DateTime?
  openedAt    DateTime?
  submittedAt DateTime?

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contactId String
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  review Review?

  createdAt DateTime @default(now())

  @@index([companyId])
}

model Review {
  id         String  @id @default(cuid())
  rating     Int
  comment    String?
  platform   String  @default("google")
  externalId String?

  companyId String
  company   Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contactId String?
  contact   Contact?       @relation(fields: [contactId], references: [id], onDelete: SetNull)
  requestId String?        @unique
  request   ReviewRequest? @relation(fields: [requestId], references: [id])

  createdAt DateTime @default(now())

  @@index([companyId])
}

// ==================== FINANCING ====================
model FinancingApplication {
  id             String   @id @default(cuid())
  status         String   @default("pending")
  amount         Decimal  @db.Decimal(12, 2)
  term           Int?
  externalId     String?
  applicationUrl String?
  approvedAmount Decimal? @db.Decimal(12, 2)

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contactId String
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
}

// ==================== SERVICE AGREEMENTS ====================
model ServiceAgreement {
  id               String    @id @default(cuid())
  number           String
  name             String
  status           String    @default("active")
  startDate        DateTime
  endDate          DateTime?
  renewalType      String    @default("auto")
  billingFrequency String    @default("monthly")
  amount           Decimal   @db.Decimal(12, 2)
  terms            String?
  notes            String?

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  contactId String
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  visits AgreementVisit[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
}

model AgreementVisit {
  id            String    @id @default(cuid())
  scheduledDate DateTime
  completedAt   DateTime?
  status        String    @default("scheduled")
  notes         String?

  agreementId String
  agreement   ServiceAgreement @relation(fields: [agreementId], references: [id], onDelete: Cascade)

  @@index([agreementId])
}

// ==================== EQUIPMENT ====================
model EquipmentCategory {
  id   String @id @default(cuid())
  name String

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  equipment Equipment[]

  @@index([companyId])
}

model Equipment {
  id             String    @id @default(cuid())
  name           String
  serialNumber   String?
  model          String?
  manufacturer   String?
  status         String    @default("active")
  location       String?
  purchaseDate   DateTime?
  warrantyExpiry DateTime?
  notes          String?

  companyId  String
  company    Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  categoryId String?
  category   EquipmentCategory? @relation(fields: [categoryId], references: [id])

  maintenanceLogs EquipmentMaintenance[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
}

model EquipmentMaintenance {
  id          String    @id @default(cuid())
  type        String
  description String?
  cost        Decimal?  @db.Decimal(10, 2)
  performedAt DateTime  @default(now())
  nextDueDate DateTime?

  equipmentId String
  equipment   Equipment @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  @@index([equipmentId])
}

// ==================== FLEET ====================
model Vehicle {
  id             String  @id @default(cuid())
  name           String
  type           String  @default("truck")
  make           String?
  model          String?
  year           Int?
  vin            String?
  licensePlate   String?
  status         String  @default("active")
  currentMileage Int?
  fuelType       String?

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  maintenanceLogs VehicleMaintenance[]
  fuelLogs        FuelLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
}

model VehicleMaintenance {
  id             String    @id @default(cuid())
  type           String
  description    String?
  cost           Decimal?  @db.Decimal(10, 2)
  mileage        Int?
  performedAt    DateTime  @default(now())
  nextDueDate    DateTime?
  nextDueMileage Int?

  vehicleId String
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
}

model FuelLog {
  id             String  @id @default(cuid())
  gallons        Decimal @db.Decimal(8, 3)
  pricePerGallon Decimal @db.Decimal(6, 3)
  totalCost      Decimal @db.Decimal(10, 2)
  mileage        Int?
  station        String?

  vehicleId String
  vehicle   Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([vehicleId])
}

// ==================== EMAIL MARKETING ====================
model EmailTemplate {
  id      String  @id @default(cuid())
  name    String
  subject String
  body    String
  type    String?
  active  Boolean @default(true)

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
}

model EmailCampaign {
  id              String    @id @default(cuid())
  name            String
  subject         String
  body            String
  status          String    @default("draft")
  recipientFilter Json?
  scheduledAt     DateTime?
  sentAt          DateTime?
  stats           Json?

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
}

model Automation {
  id         String  @id @default(cuid())
  name       String
  trigger    String
  conditions Json?
  actions    Json
  active     Boolean @default(true)

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
}

// ==================== CALL TRACKING ====================
model TrackingNumber {
  id          String  @id @default(cuid())
  phoneNumber String
  forwardTo   String
  name        String?
  source      String?
  active      Boolean @default(true)

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  calls PhoneCall[]

  createdAt DateTime @default(now())

  @@index([companyId])
}

model PhoneCall {
  id            String  @id @default(cuid())
  callerNumber  String
  status        String
  duration      Int?
  recordingUrl  String?
  transcription String?

  trackingNumberId String
  trackingNumber   TrackingNumber @relation(fields: [trackingNumberId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  Company   Company? @relation(fields: [companyId], references: [id])
  companyId String?

  @@index([trackingNumberId])
}

// ==================== SCHEDULING ====================
model ScheduleEvent {
  id     String   @id @default(cuid())
  title  String
  type   String   @default("appointment")
  start  DateTime
  end    DateTime
  allDay Boolean  @default(false)
  status String   @default("scheduled")
  notes  String?
  color  String?

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  userId    String?
  user      User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId, start])
}

model RecurringSchedule {
  id         String    @id @default(cuid())
  name       String
  pattern    String
  interval   Int       @default(1)
  daysOfWeek Int[]     @default([])
  startDate  DateTime
  endDate    DateTime?

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([companyId])
}

// ==================== SELECTIONS ====================
model SelectionCategory {
  id        String @id @default(cuid())
  name      String
  sortOrder Int    @default(0)

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  items SelectionItem[]

  @@index([companyId])
}

model SelectionItem {
  id          String   @id @default(cuid())
  name        String
  description String?
  price       Decimal  @default(0) @db.Decimal(12, 2)
  imageUrl    String?
  allowance   Decimal? @db.Decimal(12, 2)

  categoryId String
  category   SelectionCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  companyId  String
  company    Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)

  selections Selection[]

  @@index([categoryId])
}

model Selection {
  id         String    @id @default(cuid())
  status     String    @default("pending")
  notes      String?
  approvedAt DateTime?

  projectId String
  project   Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  contactId String?
  contact   Contact?      @relation(fields: [contactId], references: [id], onDelete: SetNull)
  itemId    String
  item      SelectionItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([projectId])
}

// ==================== TAKEOFFS ====================
model Takeoff {
  id     String @id @default(cuid())
  name   String
  status String @default("draft")

  companyId String
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  items TakeoffItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
}

model TakeoffItem {
  id          String  @id @default(cuid())
  name        String
  description String?
  quantity    Decimal @db.Decimal(12, 4)
  unit        String
  unitCost    Decimal @default(0) @db.Decimal(12, 2)
  totalCost   Decimal @default(0) @db.Decimal(12, 2)
  category    String?

  takeoffId String
  takeoff   Takeoff @relation(fields: [takeoffId], references: [id], onDelete: Cascade)

  @@index([takeoffId])
}

// ==================== WARRANTIES ====================
model Warranty {
  id           String    @id @default(cuid())
  name         String
  type         String
  startDate    DateTime
  endDate      DateTime?
  duration     Int?
  durationUnit String?
  coverage     String?
  notes        String?

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  claims WarrantyClaim[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
}

model WarrantyClaim {
  id          String    @id @default(cuid())
  status      String    @default("open")
  description String
  resolution  String?
  resolvedAt  DateTime?

  warrantyId String
  warranty   Warranty @relation(fields: [warrantyId], references: [id], onDelete: Cascade)
  companyId  String
  company    Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([warrantyId])
}

// ==================== BILLING ====================
model Subscription {
  id        String  @id @default(cuid())
  companyId String  @unique
  company   Company @relation(fields: [companyId], references: [id])

  stripeSubscriptionId String? @unique

  packageId    String
  billingCycle String
  status       String @default("active")

  userCount  Int      @default(1)
  basePrice  Decimal  @db.Decimal(10, 2)
  totalPrice Decimal  @db.Decimal(10, 2)
  features   String[] @default([])
  addons     Json?

  trialEndsAt        DateTime?
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  canceledAt         DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model License {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  type      String
  packageId String?
  features  Json

  amount          Decimal @db.Decimal(10, 2)
  stripePaymentId String?

  purchasedAt DateTime
  expiresAt   DateTime?
  status      String    @default("active")

  createdAt DateTime @default(now())

  @@index([companyId])
}

model AddonPurchase {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  addonId         String
  quantity        Int       @default(1)
  amount          Decimal   @db.Decimal(10, 2)
  stripePaymentId String?
  expiresAt       DateTime?

  createdAt DateTime @default(now())

  @@index([companyId])
}

model UsageRecord {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  type     String
  quantity Int    @default(1)
  metadata Json?

  recordedAt DateTime @default(now())

  @@index([companyId, type, recordedAt])
}

model BillingInvoice {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  number          String    @unique
  periodStart     DateTime
  periodEnd       DateTime
  lineItems       Json
  subtotal        Decimal   @db.Decimal(10, 2)
  tax             Decimal   @default(0) @db.Decimal(10, 2)
  total           Decimal   @db.Decimal(10, 2)
  status          String    @default("pending")
  dueDate         DateTime
  paidAt          DateTime?
  stripeInvoiceId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
}

model SelfHostedLicense {
  id               String    @id @default(cuid())
  email            String
  companyName      String
  licenseType      String // starter, pro, business, construction, full
  licenseKey       String    @unique
  stripeSessionId  String?
  stripeCustomerId String?
  purchasedAt      DateTime
  expiresAt        DateTime? // null = perpetual
  isActive         Boolean   @default(true)
  downloadCount    Int       @default(0)
  lastDownloadAt   DateTime?
  metadata         Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([licenseKey])
}

// ==================== ONLINE BOOKING ====================
model BookingSettings {
  id        String  @id @default(cuid())
  companyId String  @unique
  company   Company @relation(fields: [companyId], references: [id])

  enabled             Boolean @default(true)
  leadTimeDays        Int     @default(1)
  maxDaysOut          Int     @default(30)
  slotDurationMinutes Int     @default(60)
  workingHours        Json

  primaryColor        String?
  logo                String?
  welcomeMessage      String?
  confirmationMessage String?

  notifyEmail Boolean @default(true)
  notifySms   Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BookableService {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  name            String
  description     String?
  durationMinutes Int     @default(60)
  price           Decimal @default(0) @db.Decimal(10, 2)
  depositRequired Boolean @default(false)
  depositAmount   Decimal @default(0) @db.Decimal(10, 2)
  active          Boolean @default(true)
  sortOrder       Int     @default(0)

  bookings OnlineBooking[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
}

model OnlineBooking {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  jobId     String?
  job       Job?             @relation(fields: [jobId], references: [id])
  contactId String?
  contact   Contact?         @relation(fields: [contactId], references: [id])
  serviceId String?
  service   BookableService? @relation(fields: [serviceId], references: [id])

  customerName  String
  customerEmail String
  customerPhone String?
  scheduledDate DateTime
  notes         String?
  status        String   @default("pending")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
}

// ==================== CUSTOM FORMS ====================
model FormTemplate {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  name        String
  description String?
  category    String
  fields      Json

  requireSignature Boolean @default(false)
  requirePhoto     Boolean @default(false)
  autoAttachTo     Json?
  active           Boolean @default(true)

  submissions FormSubmission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
}

model FormSubmission {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  templateId String
  template   FormTemplate @relation(fields: [templateId], references: [id])

  jobId     String?
  job       Job?     @relation(fields: [jobId], references: [id])
  projectId String?
  project   Project? @relation(fields: [projectId], references: [id])
  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id])

  values    Json
  signature String?
  signedAt  DateTime?
  signedBy  String?

  submittedById String?
  submittedBy   User?    @relation(fields: [submittedById], references: [id])
  submittedAt   DateTime @default(now())
  status        String   @default("submitted")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([templateId])
}

// ==================== LIEN WAIVERS ====================
model LienWaiver {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  projectId String
  project   Project  @relation(fields: [projectId], references: [id])
  vendorId  String?
  vendor    Contact? @relation(fields: [vendorId], references: [id])

  vendorName String
  vendorType String?
  waiverType String

  throughDate    DateTime?
  amountPrevious Decimal   @default(0) @db.Decimal(12, 2)
  amountCurrent  Decimal   @default(0) @db.Decimal(12, 2)
  amountTotal    Decimal   @default(0) @db.Decimal(12, 2)

  status      String    @default("draft")
  requestedAt DateTime?
  dueDate     DateTime?
  receivedAt  DateTime?

  documentUrl String?
  signedDate  DateTime?
  notarized   Boolean   @default(false)

  approvedAt    DateTime?
  approvedById  String?
  approvedBy    User?     @relation("LienWaiverApproved", fields: [approvedById], references: [id])
  approvalNotes String?

  rejectedAt      DateTime?
  rejectedById    String?
  rejectedBy      User?     @relation("LienWaiverRejected", fields: [rejectedById], references: [id])
  rejectionReason String?

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([projectId])
}

// ==================== DRAW SCHEDULES ====================
model ScheduleOfValues {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  projectId String  @unique
  project   Project @relation(fields: [projectId], references: [id])

  contractAmount   Decimal @db.Decimal(12, 2)
  retainagePercent Decimal @default(10) @db.Decimal(5, 2)
  status           String  @default("draft")

  lineItems SOVLineItem[]
  draws     DrawRequest[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
}

model SOVLineItem {
  id        String @id @default(cuid())
  companyId String

  scheduleOfValuesId String
  scheduleOfValues   ScheduleOfValues @relation(fields: [scheduleOfValuesId], references: [id], onDelete: Cascade)

  itemNumber     String
  description    String
  scheduledValue Decimal @db.Decimal(12, 2)
  sortOrder      Int     @default(0)

  drawLineItems DrawLineItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([scheduleOfValuesId])
}

model DrawRequest {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  scheduleOfValuesId String
  scheduleOfValues   ScheduleOfValues @relation(fields: [scheduleOfValuesId], references: [id])
  projectId          String
  project            Project          @relation(fields: [projectId], references: [id])

  drawNumber Int
  periodFrom DateTime?
  periodTo   DateTime?

  grossAmount     Decimal @default(0) @db.Decimal(12, 2)
  retainageAmount Decimal @default(0) @db.Decimal(12, 2)
  netAmount       Decimal @default(0) @db.Decimal(12, 2)

  status      String    @default("draft")
  submittedAt DateTime?

  approvedAt    DateTime?
  approvedById  String?
  approvedBy    User?     @relation("DrawApproved", fields: [approvedById], references: [id])
  approvalNotes String?

  rejectedAt      DateTime?
  rejectedById    String?
  rejectedBy      User?     @relation("DrawRejected", fields: [rejectedById], references: [id])
  rejectionReason String?

  lineItems DrawLineItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([scheduleOfValuesId, drawNumber])
  @@index([companyId])
  @@index([projectId])
}

model DrawLineItem {
  id        String @id @default(cuid())
  companyId String

  drawRequestId String
  draw          DrawRequest @relation(fields: [drawRequestId], references: [id], onDelete: Cascade)

  sovLineItemId String
  sovLineItem   SOVLineItem @relation(fields: [sovLineItemId], references: [id])

  completedThisPeriod Decimal @default(0) @db.Decimal(12, 2)
  materialsStored     Decimal @default(0) @db.Decimal(12, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([drawRequestId])
}

// ==================== AUDIT LOG ====================
model AuditLog {
  id         String   @id @default(cuid())
  action     String
  entity     String
  entityId   String?
  entityName String?
  changes    Json?
  metadata   Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  userId    String?
  userName  String?
  userEmail String?

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([entity, entityId])
  @@index([userId])
  @@index([createdAt])
}


//  PAID ADS 

// One per platform per company  holds the connected ad account credentials
model AdAccount {
  id        String   @id @default(cuid())
  companyId String
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  platform    String  // google | meta
  accountId   String? // platform account ID (populated after API connection)
  accountName String?
  status      String  @default("pending") // pending | connected | error | disconnected

  // Encrypted API tokens (stored after OAuth or manual entry)
  accessToken  String?
  refreshToken String?
  tokenExpiry  DateTime?

  // Agency-level: BuildPro manages this account on behalf of contractor
  managerId    String? // Google MCC / Meta Business Manager ID
  customerId   String? // Contractor's account ID within our MCC

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaigns AdCampaign[]

  @@unique([companyId, platform])
  @@index([companyId])
}

// Each contractor gets a campaign per platform per service type
model AdCampaign {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  adAccountId String
  adAccount   AdAccount @relation(fields: [adAccountId], references: [id], onDelete: Cascade)

  platform     String  // google | meta
  campaignType String  // search | lsa | performance_max | lead_form | retargeting | visualizer
  name         String
  status       String  @default("draft") // draft | active | paused | ended | error

  // Platform campaign ID (set after API creates the campaign)
  platformCampaignId String?

  // Budget
  dailyBudget  Decimal? @db.Decimal(10, 2)
  monthlyBudget Decimal? @db.Decimal(10, 2)
  totalSpend    Decimal  @default(0) @db.Decimal(10, 2)

  // Performance (synced from platform)
  impressions Int     @default(0)
  clicks      Int     @default(0)
  leads       Int     @default(0)
  costPerLead Decimal @default(0) @db.Decimal(10, 2)
  ctr         Decimal @default(0) @db.Decimal(5, 4)

  // Alert threshold  notify when CPL exceeds this
  cplAlertThreshold Decimal? @db.Decimal(10, 2)
  lastAlertSentAt   DateTime?

  // Config (keywords, ad copy, targeting  JSON)
  config Json @default("{}")

  startDate DateTime?
  endDate   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reports AdReport[]

  @@index([companyId])
  @@index([status])
  @@index([platform])
}

// Monthly performance snapshot  generated on the 1st, emailed to contractor
model AdReport {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  campaignId String?
  campaign   AdCampaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)

  reportType String   // monthly | weekly | alert
  periodStart DateTime
  periodEnd   DateTime

  // Aggregated metrics
  totalSpend   Decimal @default(0) @db.Decimal(10, 2)
  totalLeads   Int     @default(0)
  totalClicks  Int     @default(0)
  costPerLead  Decimal @default(0) @db.Decimal(10, 2)
  conversionRate Decimal @default(0) @db.Decimal(5, 4)

  // Revenue attribution (from CRM  jobs created from leads in this period)
  revenueAttributed Decimal @default(0) @db.Decimal(10, 2)
  jobsAttributed    Int     @default(0)

  // Raw data snapshot (full platform response stored for reference)
  rawData Json @default("{}")

  // Email delivery
  sentAt      DateTime?
  sentTo      String?
  emailStatus String @default("pending") // pending | sent | failed

  createdAt DateTime @default(now())

  @@index([companyId])
  @@index([reportType])
  @@index([periodStart])
}
//  FACTORY TRACKING 

model FactoryCustomer {
  id        String @id @default(cuid())
  companyId String // The operator's company that generated this
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Customer info
  name        String
  slug        String
  email       String
  phone       String?
  domain      String?
  industry    String?

  // Products & features
  products String[] @default([])
  features String[] @default([])

  // Branding
  primaryColor   String?
  secondaryColor String?
  logo           String?

  // Deployment
  status      String @default("generated") // generated, deployed, active, suspended, canceled
  deployedUrl String?
  apiUrl      String?
  siteUrl     String?

  // Billing
  billingType     String?  // 'subscription', 'one_time', 'free'
  billingStatus   String   @default("pending") // pending, active, past_due, canceled
  planId          String?
  monthlyAmount   Decimal? @db.Decimal(10, 2)
  oneTimeAmount   Decimal? @db.Decimal(10, 2)
  paidAt          DateTime?
  nextBillingDate DateTime?
  stripeCustomerId     String?
  stripeSubscriptionId String?

  // Metadata
  notes            String?
  buildId          String?  // References the generated zip build ID
  renderServiceIds String?  // JSON: Render service IDs after deploy (backend, frontend, site, database)
  adminEmail       String?
  adminPassword    String? // Stored temporarily, cleared after first login

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  builds FactoryBuild[]

  @@index([companyId])
  @@index([status])
  @@index([billingStatus])
}

model FactoryBuild {
  id         String @id @default(cuid())
  customerId String?
  customer   FactoryCustomer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Build config
  companyName String
  slug        String
  products    String[] @default([])
  features    String[] @default([])
  config      Json?

  // Output
  zipPath  String?
  zipName  String?
  buildId  String @unique
  fileSize Int?

  status String @default("complete") // generating, complete, failed

  createdAt DateTime @default(now())

  @@index([companyId])
  @@index([customerId])
}

// Atomic document number sequences  prevents INV/JOB/QTE duplicates under concurrency
model DocumentSequence {
  key        String   @id  // e.g. "INV:company123"
  lastNumber Int      @default(0)
  updatedAt  DateTime @updatedAt

  @@index([key])
}
