# BuildPro — Render Blueprint
# Defines the backend web service + two cron jobs.
#
# CRON JOBS (audit issues #19 & #20)
# ─────────────────────────────────────────────────────────────────────────────
# Both endpoints exist and are protected by X-Cron-Secret. They were never
# auto-triggered because no scheduler was configured. This file fixes that.
#
# SETUP: Make sure CRON_SECRET is set in your Render environment variables.
# Generate one with:  node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
#
# DEPLOY: In Render dashboard → New → Blueprint → point to this repo.

services:
  # ── Backend Web Service ────────────────────────────────────────────────────
  - type: web
    name: buildpro-backend
    runtime: node
    plan: starter   # NOTE: Starter = 512MB RAM. Large PDF generation (many line items) may OOM.
                    # Upgrade to Standard (2GB) if you see OOM crashes in production.
    rootDir: backend
    buildCommand: npm install && npx prisma migrate deploy
    startCommand: node src/index.js
    healthCheckPath: /health
    envVars:
      - key: NODE_ENV
        value: production
      - key: NODE_VERSION
        value: "20"
      - key: DATABASE_URL
        fromDatabase:
          name: buildpro-db
          property: connectionString
      - key: JWT_SECRET
        generateValue: true
      - key: JWT_REFRESH_SECRET
        generateValue: true
      - key: CRON_SECRET
        generateValue: true
      - key: FIELD_ENCRYPTION_KEY
        sync: false   # Set manually — must be a 64-char hex string
      - key: STORAGE_BACKEND
        value: s3
      - key: FRONTEND_URL
        sync: false   # e.g. https://app.buildpro.com
      - key: STRIPE_SECRET_KEY
        sync: false
      - key: STRIPE_WEBHOOK_SECRET
        sync: false
      - key: SENDGRID_API_KEY
        sync: false
      - key: FROM_EMAIL
        sync: false
      - key: SENTRY_DSN
        sync: false
      - key: DB_BACKUPS_CONFIRMED
        value: "true"  # Set to true once you've confirmed Render managed DB backups are enabled on your plan
      - key: CALLRAIL_WEBHOOK_SECRET
        sync: false   # Required if using CallRail integration — get from CallRail dashboard
      - key: WISETACK_WEBHOOK_SECRET
        sync: false   # Required if using Wisetack financing integration
      - key: SETUP_SECRET
        sync: false   # One-time use: set to bootstrap first agency_admin, remove after use

  # ── Cron Job: Recurring Invoices ───────────────────────────────────────────
  # Runs daily at 8am UTC. Finds all recurring invoice schedules where
  # next_due_date <= today and generates invoices for them.
  - type: cron
    name: buildpro-recurring-invoices
    runtime: node
    plan: starter
    rootDir: backend
    buildCommand: npm install
    schedule: "0 8 * * *"
    startCommand: >
      node -e "
        fetch(
          process.env.API_URL + '/api/v1/recurring/process-due',
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Cron-Secret': process.env.CRON_SECRET
            }
          }
        )
        .then(r => r.json())
        .then(d => { console.log('Recurring invoices processed:', d); process.exit(0); })
        .catch(e => { console.error('Recurring invoice cron failed:', e); process.exit(1); })
      "
    envVars:
      - key: API_URL
        sync: false   # e.g. https://buildpro-backend.onrender.com
      - key: CRON_SECRET
        fromService:
          name: buildpro-backend
          type: web
          property: CRON_SECRET

  # ── Cron Job: Scheduled Reviews ────────────────────────────────────────────
  # Runs daily at 9am UTC. Sends review request emails for jobs completed
  # N days ago (configurable via the reviews settings in the app).
  - type: cron
    name: buildpro-scheduled-reviews
    runtime: node
    plan: starter
    rootDir: backend
    buildCommand: npm install
    schedule: "0 9 * * *"
    startCommand: >
      node -e "
        fetch(
          process.env.API_URL + '/api/v1/reviews/process-scheduled',
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Cron-Secret': process.env.CRON_SECRET
            }
          }
        )
        .then(r => r.json())
        .then(d => { console.log('Scheduled reviews processed:', d); process.exit(0); })
        .catch(e => { console.error('Review cron failed:', e); process.exit(1); })
      "
    envVars:
      - key: API_URL
        sync: false   # e.g. https://buildpro-backend.onrender.com
      - key: CRON_SECRET
        fromService:
          name: buildpro-backend
          type: web
          property: CRON_SECRET

  # ── Frontend Static Site ─────────────────────────────────────────────────
  - type: web
    name: buildpro-frontend
    runtime: static
    rootDir: frontend
    buildCommand: npm install && npm run build
    staticPublishPath: dist
    headers:
      - path: /*
        name: Cache-Control
        value: public, max-age=0, must-revalidate
      - path: /assets/*
        name: Cache-Control
        value: public, max-age=31536000, immutable
    routes:
      - type: rewrite
        source: /*
        destination: /index.html
    envVars:
      - key: VITE_API_URL
        sync: false   # e.g. https://buildpro-backend.onrender.com
      - key: VITE_STRIPE_PUBLISHABLE_KEY
        sync: false

  # ── Cron Job: Ad Metrics Sync ─────────────────────────────────────────────
  # Runs daily at 6am UTC. Pulls latest spend/leads/clicks from Google Ads
  # and Meta Marketing API for all connected ad accounts.
  - type: cron
    name: buildpro-ad-metrics-sync
    runtime: node
    plan: starter
    rootDir: backend
    buildCommand: npm install
    schedule: "0 6 * * *"
    startCommand: >
      node -e "
        fetch(
          process.env.API_URL + '/api/v1/ads/sync',
          { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Cron-Secret': process.env.CRON_SECRET } }
        )
        .then(r => r.json())
        .then(d => { console.log('Ad metrics synced:', d); process.exit(0); })
        .catch(e => { console.error('Ad metrics sync failed:', e); process.exit(1); })
      "
    envVars:
      - key: API_URL
        sync: false
      - key: CRON_SECRET
        fromService:
          name: buildpro-backend
          type: web
          property: CRON_SECRET

  # ── Cron Job: Monthly Ad Reports ──────────────────────────────────────────
  # Runs 1st of each month at 7am UTC. Generates and emails performance
  # reports to every contractor with active ad campaigns.
  - type: cron
    name: buildpro-monthly-ad-reports
    runtime: node
    plan: starter
    rootDir: backend
    buildCommand: npm install
    schedule: "0 7 1 * *"
    startCommand: >
      node -e "
        fetch(
          process.env.API_URL + '/api/v1/ads/process-monthly-reports',
          { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Cron-Secret': process.env.CRON_SECRET } }
        )
        .then(r => r.json())
        .then(d => { console.log('Monthly ad reports processed:', d); process.exit(0); })
        .catch(e => { console.error('Monthly ad reports failed:', e); process.exit(1); })
      "
    envVars:
      - key: API_URL
        sync: false
      - key: CRON_SECRET
        fromService:
          name: buildpro-backend
          type: web
          property: CRON_SECRET

  # ── Cron Job: Drip Email Processing ───────────────────────────────────────
  # Runs hourly. Sends drip sequence emails due based on enrollment + delay.
  - type: cron
    name: buildpro-drip-emails
    runtime: node
    plan: starter
    rootDir: backend
    buildCommand: npm install
    schedule: "0 * * * *"
    startCommand: >
      node -e "
        fetch(
          process.env.API_URL + '/api/v1/marketing/sequences/process-due',
          { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Cron-Secret': process.env.CRON_SECRET } }
        )
        .then(r => r.json())
        .then(d => { console.log('Drip emails processed:', d); process.exit(0); })
        .catch(e => { console.error('Drip email cron failed:', e); process.exit(1); })
      "
    envVars:
      - key: API_URL
        sync: false
      - key: CRON_SECRET
        fromService:
          name: buildpro-backend
          type: web
          property: CRON_SECRET

databases:
  - name: buildpro-db
    plan: starter
